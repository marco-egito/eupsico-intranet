<div id="toast-container"></div>
<div class="container">
    <h1>Configurações Gerais</h1>
    <div class="tab">
        <button class="tablinks" data-tab="GestaoUsuarios" id="defaultOpen">Gestão de Usuários</button>
    </div>

    <div id="GestaoUsuarios" class="tabcontent">
        <h2>Gestão de Usuários do Sistema</h2>
        <p>Adicione ou edite os dados de um usuário. O e-mail deve corresponder ao usado para login no Google.</p>
        <div class="button-bar">
            <button class="action-button add-row-btn" id="add-usuario-btn">Adicionar Usuário</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="usuarios-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Username</th>
                        <th>Profissão</th>
                        <th>Faz Atendimento?</th>
                        <th>Funções</th>
                        <th>1ª Fase?</th>
                        <th>Recebe Direto?</th>
                        <th>Inativo?</th>
                        <th style="min-width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title">Adicionar Novo Usuário</h2></div>
        <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group"><label for="user-nome">Nome Completo</label><input type="text" id="user-nome" required></div>
                <div class="form-group"><label for="user-email">E-mail (para login)</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label for="user-tel">Telefone</label><input type="text" id="user-tel" required></div>
                
                <div class="form-group">
                    <label for="user-profissao">Profissão</label>
                    <select id="user-profissao">
                        <option value="">Não especificada</option>
                        <option value="Psicologo">Psicólogo(a)</option>
                        <option value="Psicopedagogo">Psicopedagogo(a)</option>
                        <option value="Musicoterapeuta">Musicoterapeuta</option>
                        <option value="Nutricionista">Nutricionista</option>
                        <option value="Assistente Social">Assistente Social</option>
                        <option value="Outra">Outra</option>
                    </select>
                    <input type="text" id="user-profissao-outra" placeholder="Digite a profissão" style="display:none; margin-top: 8px;">
                </div>

                <div class="form-group checkbox-group">
                    <h4>Funções de Acesso:</h4>
                    <label><input type="checkbox" name="funcoes" value="admin"> Admin</label>
                    <label><input type="checkbox" name="funcoes" value="financeiro"> Financeiro</label>
                    <label><input type="checkbox" name="funcoes" value="gestor"> Gestor</label>
                    <label><input type="checkbox" name="funcoes" value="supervisor"> Supervisor</label>
                </div>
                <div class="form-group checkbox-group">
                    <h4>Status e Condições:</h4>
                    <label><input type="checkbox" id="user-faz-atendimento"> Faz Atendimento?</label>
                    <label><input type="checkbox" id="user-primeira-fase"> Primeira Fase?</label>
                    <label><input type="checkbox" id="user-recebe-direto"> Recebe Direto?</label>
                    <label><input type="checkbox" id="user-inativo"> Marcar como Inativo?</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="modal-cancel-btn" class="action-button" style="background-color: #6c757d;">Cancelar</button>
            <button id="modal-save-btn" class="action-button" style="background-color: #28a745;">Salvar</button>
        </div>
    </div>
</div>

<style>
    /* ... O CSS completo, como na resposta anterior ... */
    .container { max-width: 1200px; margin: 0 auto; background-color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    h1 { text-align: center; color: #004a7f; padding: 20px 0; margin: 0; }
    h2 { color: #333; }
    .tab { overflow: hidden; border-bottom: 1px solid #ccc; background-color: #f1f1f1; }
    .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; font-weight: bold; color: #555; }
    .tab button:hover { background-color: #ddd; }
    .tab button.active { background-color: #004a7f; color: white; }
    .tabcontent { display: none; padding: 20px; border-top: none; animation: fadeEffect 0.5s; }
    @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
    input[type="text"], input[type="email"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
    input[type="checkbox"] { transform: scale(1.2); margin-right: 5px; }
    input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .checkbox-group label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal; }
    .checkbox-group h4 { margin-top: 10px; margin-bottom: 10px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
    thead th { background-color: #e9ecef; }
    .action-button { border: none; padding: 8px 12px; font-size: 0.9em; font-weight: bold; border-radius: 5px; cursor: pointer; color: white; margin-right: 5px; }
    .add-row-btn { background-color: #007bff; }
    .delete-row-btn { background-color: #dc3545; }
    .edit-row-btn { background-color: #ffc107; color: #212529; }
    .button-bar { margin-bottom: 20px; overflow: hidden; }
    .button-bar .add-row-btn { float: left; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    .modal-header h2 { margin: 0; color: #004a7f; }
    .modal-footer { padding-top: 15px; border-top: 1px solid #eee; text-align: right; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background-color: #333; color: white; padding: 15px 20px; border-radius: 5px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.toast-success { background-color: #28a745; }
    .toast.toast-error { background-color: #dc3545; }
</style>

<script type="module">
    // Importe todas as funções necessárias do Firebase
    import { collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
    import { getIdToken } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    
    // Como esta página é carregada dinamicamente, ela precisa ter acesso às instâncias de 'db' e 'auth' criadas no index.html
    const db = window.db; 
    const auth = window.auth;
    
    // A EXECUÇÃO SÓ COMEÇA QUANDO TEMOS CERTEZA QUE 'db' E 'auth' EXISTEM
    if (db && auth) {
        
        // CORREÇÃO: A inicialização do 'functions' foi movida para DENTRO deste bloco seguro.
        // E a forma de pegar o 'app' foi corrigida para usar 'auth.app'.
        const functions = getFunctions(auth.app, 'us-central1');

        (function() {
            const usuariosCollectionRef = collection(db, 'usuarios');
            const userModal = document.getElementById('user-modal');
            let localUsuariosList = [];

            // A PARTIR DAQUI, O RESTO DO CÓDIGO É O MESMO
            function openTab(evt, tabName) { /* ...código da função... */ }
            // ... (restante das suas funções e lógica que já funcionavam)
            function openTab(evt, tabName) {
                document.querySelectorAll(".tabcontent").forEach(tc => tc.style.display = "none");
                document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
                const tabElement = document.getElementById(tabName);
                if(tabElement) tabElement.style.display = "block";
                if (evt && evt.currentTarget) evt.currentTarget.classList.add("active");
            }

            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }

            function openUserModal(user = null) {
                const form = document.getElementById('user-form');
                form.reset();
                document.getElementById('modal-title').textContent = user ? 'Editar Usuário' : 'Adicionar Novo Usuário';
                document.getElementById('user-id').value = user ? user.id : '';
                document.getElementById('user-email').disabled = !!user;
                document.getElementById('user-profissao-outra').style.display = 'none';

                if (user) {
                    document.getElementById('user-nome').value = user.nome || '';
                    document.getElementById('user-email').value = user.email || '';
                    document.getElementById('user-tel').value = user.contato || '';
                    document.getElementById('user-inativo').checked = user.inativo || false;
                    document.getElementById('user-primeira-fase').checked = user.primeiraFase || false;
                    document.getElementById('user-recebe-direto').checked = user.recebeDireto || false;
                    document.getElementById('user-faz-atendimento').checked = user.fazAtendimento || false;
                    const profissaoSelect = document.getElementById('user-profissao');
                    const profissaoOutraInput = document.getElementById('user-profissao-outra');
                    const options = Array.from(profissaoSelect.options).map(opt => opt.value);
                    if (user.profissao && options.includes(user.profissao)) {
                        profissaoSelect.value = user.profissao;
                    } else if (user.profissao) {
                        profissaoSelect.value = 'Outra';
                        profissaoOutraInput.value = user.profissao;
                        profissaoOutraInput.style.display = 'block';
                    }
                    form.querySelectorAll('input[name="funcoes"]').forEach(checkbox => {
                        checkbox.checked = user.funcoes && user.funcoes.includes(checkbox.value);
                    });
                }
                userModal.style.display = 'block';
            }

            function closeUserModal() { userModal.style.display = 'none'; }

            function renderTable(usuariosList) {
                const tableBody = document.querySelector('#usuarios-table tbody');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                
                usuariosList.forEach(user => {
                    const row = tableBody.insertRow();
                    const funcoesStr = Array.isArray(user.funcoes) ? user.funcoes.join(', ') : 'Nenhuma';
                    row.innerHTML = `
                        <td>${user.nome || ''}</td>
                        <td>${user.username || ''}</td>
                        <td>${user.profissao || 'N/A'}</td>
                        <td style="text-align: center;">${user.fazAtendimento ? 'Sim' : 'Não'}</td>
                        <td>${funcoesStr}</td>
                        <td style="text-align: center;">${user.primeiraFase ? 'Sim' : 'Não'}</td>
                        <td style="text-align: center;">${user.recebeDireto ? 'Sim' : 'Não'}</td>
                        <td style="text-align: center;">${user.inativo ? 'Sim' : 'Não'}</td>
                        <td>
                            <button class="action-button edit-row-btn" data-id="${user.id}">Editar</button>
                            <button class="action-button delete-row-btn" data-id="${user.id}">Excluir</button>
                        </td>`;
                });
            }

            function loadUsuarios() {
                const q = query(usuariosCollectionRef, orderBy('nome'));
                onSnapshot(q, (snapshot) => {
                    localUsuariosList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTable(localUsuariosList);
                }, (error) => {
                    console.error("Erro ao carregar usuários: ", error);
                    showToast("Erro ao carregar usuários.", "error");
                });
            }

            document.querySelector('.tab').addEventListener('click', (event) => {
                if (event.target.classList.contains('tablinks')) {
                    const tabName = event.target.dataset.tab;
                    openTab(event, tabName);
                }
            });

            document.getElementById('add-usuario-btn').addEventListener('click', () => openUserModal());
            document.getElementById('modal-cancel-btn').addEventListener('click', closeUserModal);
            
            document.getElementById('user-profissao').addEventListener('change', (e) => {
                document.getElementById('user-profissao-outra').style.display = e.target.value === 'Outra' ? 'block' : 'none';
            });

            document.getElementById('modal-save-btn').addEventListener('click', async () => {
                const id = document.getElementById('user-id').value;
                const funcoesSelecionadas = [];
                document.querySelectorAll('input[name="funcoes"]:checked').forEach(cb => funcoesSelecionadas.push(cb.value));

                let profissaoFinal = document.getElementById('user-profissao').value;
                if (profissaoFinal === 'Outra') {
                    profissaoFinal = document.getElementById('user-profissao-outra').value.trim();
                }

                const userData = {
                    nome: document.getElementById('user-nome').value.trim(),
                    email: document.getElementById('user-email').value.trim(),
                    contato: document.getElementById('user-tel').value.trim(),
                    funcoes: funcoesSelecionadas,
                    inativo: document.getElementById('user-inativo').checked,
                    primeiraFase: document.getElementById('user-primeira-fase').checked,
                    recebeDireto: document.getElementById('user-recebe-direto').checked,
                    profissao: profissaoFinal,
                    fazAtendimento: document.getElementById('user-faz-atendimento').checked,
                };
                
                if(id) {
                    const gerarUsername = (nomeCompleto) => {
                        if (!nomeCompleto) return "";
                        const nomes = nomeCompleto.trim().split(" ").filter(Boolean);
                        if (nomes.length <= 1) return nomes[0] || "";
                        return `${nomes[0]} ${nomes[nomes.length - 1]}`;
                    };
                    userData.username = gerarUsername(userData.nome);
                }

                if (!userData.nome || !userData.email) {
                    showToast('Nome e E-mail são obrigatórios.', 'error'); return;
                }

                const saveBtn = document.getElementById('modal-save-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Salvando...';

                try {
                    if (!auth.currentUser) throw new Error("Usuário não está logado ou a sessão expirou.");
                    await getIdToken(auth.currentUser, true);

                    if (id) {
                        const userDocRef = doc(db, 'usuarios', id);
                        await updateDoc(userDocRef, userData);
                        showToast('Usuário atualizado com sucesso!', 'success');
                    } else {
                        const criarUsuario = httpsCallable(functions, 'criarUsuarioComDados');
                        const result = await criarUsuario(userData);
                        showToast(result.data.message, 'success');
                    }
                    closeUserModal();
                } catch (error) {
                    showToast('Erro: ' + error.message, 'error');
                    console.error("Erro ao salvar usuário:", error);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Salvar';
                }
            });

            document.getElementById('usuarios-table').addEventListener('click', (e) => {
                const userId = e.target.dataset.id;
                if (!userId) return;

                if (e.target.classList.contains('edit-row-btn')) {
                    const userToEdit = localUsuariosList.find(u => u.id === userId);
                    if(userToEdit) openUserModal(userToEdit);
                }

                if (e.target.classList.contains('delete-row-btn')) {
                    if (confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                        const userDocRef = doc(db, 'usuarios', userId);
                        deleteDoc(userDocRef)
                            .then(() => showToast('Usuário excluído!', 'success'))
                            .catch(err => showToast('Erro ao excluir: ' + err.message, 'error'));
                    }
                }
            });

            const defaultOpenButton = document.getElementById("defaultOpen");
            if (defaultOpenButton) defaultOpenButton.click();
            
            loadUsuarios();
        })();

    } else {
        console.error("ERRO: As instâncias do Firebase (db, auth) não foram encontradas. O script de configuracoes.html não pode ser executado.");
    }
</script>
