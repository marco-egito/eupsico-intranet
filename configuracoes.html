<div id="toast-container"></div>
<div class="container">
    <h1>Configurações Gerais</h1>
    <div class="tab">
        <button class="tablinks" data-tab="GestaoUsuarios" id="defaultOpen">Gestão de Usuários</button>
    </div>

    <div id="GestaoUsuarios" class="tabcontent">
        <h2>Gestão de Usuários do Sistema</h2>
        <p>Adicione ou edite os dados de um usuário. O e-mail deve corresponder ao usado para login no Google.</p>
        <div class="button-bar">
            <button class="action-button add-row-btn" id="add-usuario-btn">Adicionar Usuário</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="usuarios-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Username</th>
                        <th>Profissão</th>
                        <th>Faz Atendimento?</th>
                        <th>Funções</th>
                        <th>1ª Fase?</th>
                        <th>Recebe Direto?</th>
                        <th>Inativo?</th>
                        <th style="min-width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="user-modal" class="modal">
    </div>

<style>
    /* ... (seu CSS não muda) ... */
</style>

<script type="module">
    // Como esta página é carregada dinamicamente, ela precisa ter acesso às instâncias de 'db' e 'auth' criadas no index.html
    const db = window.db; 
    const auth = window.auth;

    // Importe todas as funções necessárias do Firebase
    import { collection, query, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";
    import { getIdToken } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    
    // Se db ou auth não estiverem disponíveis, pare a execução para evitar erros
    if (!db || !auth) {
        console.error("Instâncias do Firebase (db, auth) não encontradas. Certifique-se de que index.html as expôs globalmente.");
        return;
    }

    const functions = getFunctions(getApp(db), 'us-central1'); // Reobtém a instância do functions

    (function() {
        const usuariosCollectionRef = collection(db, 'usuarios');
        const userModal = document.getElementById('user-modal');
        let localUsuariosList = [];

        // ... (as funções openTab, showToast, openUserModal, closeUserModal e renderTable não mudam) ...
        
        function loadUsuarios() {
            // Nova sintaxe para queries e listeners em tempo real
            const q = query(usuariosCollectionRef, orderBy('nome'));
            onSnapshot(q, (snapshot) => {
                localUsuariosList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(localUsuariosList);
            }, (error) => {
                console.error("Erro ao carregar usuários: ", error);
                showToast("Erro ao carregar usuários.", "error");
            });
        }

        // ... (os event listeners para abas, botões do modal, etc. não mudam) ...

        document.getElementById('modal-save-btn').addEventListener('click', async () => {
            const id = document.getElementById('user-id').value;
            // ... (a lógica para coletar dados do formulário não muda) ...
            const userData = { /* ... dados do usuário ... */ };
            
            if (!userData.nome || !userData.email) { /* ... */ }

            const saveBtn = document.getElementById('modal-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            try {
                if (!auth.currentUser) throw new Error("Usuário não está logado ou a sessão expirou.");
                await getIdToken(auth.currentUser, true); // RENOVA O TOKEN

                if (id) {
                    // MODO EDIÇÃO: Nova sintaxe para atualizar um documento
                    const userDocRef = doc(db, 'usuarios', id);
                    await updateDoc(userDocRef, userData);
                    showToast('Usuário atualizado com sucesso!', 'success');
                } else {
                    // MODO CRIAÇÃO: Nova sintaxe para chamar a Cloud Function
                    const criarUsuario = httpsCallable(functions, 'criarUsuarioComDados');
                    const result = await criarUsuario(userData);
                    showToast(result.data.message, 'success');
                }
                closeUserModal();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
                console.error("Erro ao salvar usuário:", error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar';
            }
        });

        document.getElementById('usuarios-table').addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            if (!userId) return;

            if (e.target.classList.contains('edit-row-btn')) {
                const userToEdit = localUsuariosList.find(u => u.id === userId);
                if(userToEdit) openUserModal(userToEdit);
            }

            if (e.target.classList.contains('delete-row-btn')) {
                if (confirm('Tem certeza que deseja excluir este usuário?')) {
                    // Nova sintaxe para deletar um documento
                    const userDocRef = doc(db, 'usuarios', userId);
                    deleteDoc(userDocRef)
                        .then(() => showToast('Usuário excluído!', 'success'))
                        .catch(err => showToast('Erro ao excluir: ' + err.message, 'error'));
                }
            }
        });

        const defaultOpenButton = document.getElementById("defaultOpen");
        if (defaultOpenButton) defaultOpenButton.click();
        
        loadUsuarios();
    })();
</script>
