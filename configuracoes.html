<div id="toast-container"></div>
<div class="container">
    <h1>Configurações Gerais</h1>
    <div class="tab">
        <button class="tablinks" data-tab="GestaoUsuarios" id="defaultOpen">Gestão de Usuários</button>
        </div>

    <div id="GestaoUsuarios" class="tabcontent">
        <h2>Gestão de Usuários do Sistema</h2>
        <p>Adicione ou edite os dados de um usuário. O e-mail deve corresponder ao usado para login no Google.</p>
        <div class="button-bar">
            <button class="action-button add-row-btn" id="add-usuario-btn">Adicionar Usuário</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="usuarios-table">
                <thead>
                    <tr>
                        <th>Nome</th><th>E-mail (Login)</th><th>Telefone</th><th>Funções</th><th>Inativo?</th><th style="min-width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title">Adicionar Novo Usuário</h2></div>
        <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group"><label for="user-nome">Nome Completo</label><input type="text" id="user-nome" required></div>
                <div class="form-group"><label for="user-email">E-mail (para login)</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label for="user-tel">Telefone</label><input type="text" id="user-tel" required></div>
                <div class="form-group checkbox-group">
                    <h4>Funções de Acesso:</h4>
                    <label><input type="checkbox" name="funcoes" value="admin"> Admin</label>
                    <label><input type="checkbox" name="funcoes" value="financeiro"> Financeiro</label>
                    <label><input type="checkbox" name="funcoes" value="gestor"> Gestor</label>
                    <label><input type="checkbox" name="funcoes" value="supervisor"> Supervisor</label>
                </div>
                <div class="form-group checkbox-group">
                     <label><input type="checkbox" id="user-inativo"> Marcar como Inativo?</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="modal-cancel-btn" class="action-button" style="background-color: #6c757d;">Cancelar</button>
            <button id="modal-save-btn" class="action-button" style="background-color: #28a745;">Salvar</button>
        </div>
    </div>
</div>

<style>
    .container { max-width: 1200px; margin: 0 auto; background-color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    h1 { text-align: center; color: #004a7f; padding: 20px 0; margin: 0; }
    .tab { overflow: hidden; border-bottom: 1px solid #ccc; background-color: #f1f1f1; }
    .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; font-weight: bold; color: #555; }
    .tab button:hover { background-color: #ddd; }
    .tab button.active { background-color: #004a7f; color: white; }
    .tabcontent { display: none; padding: 20px; border-top: none; animation: fadeEffect 0.5s; }
    @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
    input[type="text"], input[type="email"], input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
    input[type="checkbox"] { transform: scale(1.2); margin-right: 5px; }
    input:disabled { background-color: #e9ecef; cursor: not-allowed; }
    .checkbox-group label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal; }
    .checkbox-group h4 { margin-top: 10px; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
    thead th { background-color: #e9ecef; }
    .action-button { border: none; padding: 8px 12px; font-size: 0.9em; font-weight: bold; border-radius: 5px; cursor: pointer; color: white; margin-right: 5px; }
    .save-btn { background-color: #28a745; float: right; padding: 10px 20px; font-size: 1em; }
    .add-row-btn { background-color: #007bff; }
    .delete-row-btn { background-color: #dc3545; }
    .edit-row-btn { background-color: #ffc107; color: #212529; }
    .save-row-btn { background-color: #28a745; }
    .button-bar { margin-bottom: 20px; overflow: hidden; }
    .button-bar .add-row-btn { float: left; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    .modal-header h2 { margin: 0; color: #004a7f; }
    .modal-footer { padding-top: 15px; border-top: 1px solid #eee; text-align: right; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background-color: #333; color: white; padding: 15px 20px; border-radius: 5px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.toast-success { background-color: #28a745; }
    .toast.toast-error { background-color: #dc3545; }
</style>

<script>
    (function() {
        // Todo o código agora está dentro de um escopo seguro.
        
        const usuariosCollection = db.collection('usuarios');
        const userModal = document.getElementById('user-modal');
        let localUsuariosList = []; 

        // --- FUNÇÕES UTILITÁRIAS (Toast, Abas, Modal) ---
        function openTab(evt, tabName) {
            document.querySelectorAll(".tabcontent").forEach(tc => tc.style.display = "none");
            document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
            
            const tabElement = document.getElementById(tabName);
            if(tabElement) tabElement.style.display = "block";
            
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add("active");
            }
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function openUserModal(user = null) {
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('modal-title').textContent = user ? 'Editar Usuário' : 'Adicionar Novo Usuário';
            document.getElementById('user-id').value = user ? user.id : '';
            document.getElementById('user-email').disabled = !!user;
            
            if (user) {
                document.getElementById('user-nome').value = user.nome || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-tel').value = user.contato || '';
                document.getElementById('user-inativo').checked = user.inativo || false;
                
                form.querySelectorAll('input[name="funcoes"]').forEach(checkbox => {
                    checkbox.checked = user.funcoes && user.funcoes.includes(checkbox.value);
                });
            }
            userModal.style.display = 'block';
        }

        function closeUserModal() {
            userModal.style.display = 'none';
        }

        // --- RENDERIZAÇÃO E DADOS (FIRESTORE) ---
        function renderTable(usuariosList) {
            const tableBody = document.querySelector('#usuarios-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            usuariosList.forEach(user => {
                const row = tableBody.insertRow();
                const funcoesStr = Array.isArray(user.funcoes) ? user.funcoes.join(', ') : 'Nenhuma';
                row.innerHTML = `
                    <td>${user.nome || ''}</td>
                    <td>${user.email || ''}</td>
                    <td>${user.contato || ''}</td>
                    <td>${funcoesStr}</td>
                    <td style="text-align: center;">${user.inativo ? 'Sim' : 'Não'}</td>
                    <td>
                        <button class="action-button edit-row-btn" data-id="${user.id}">Editar</button>
                        <button class="action-button delete-row-btn" data-id="${user.id}">Excluir</button>
                    </td>`;
            });
        }

        function loadUsuarios() {
            usuariosCollection.orderBy('nome').onSnapshot(snapshot => {
                localUsuariosList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(localUsuariosList);
            }, error => {
                console.error("Erro ao carregar usuários: ", error);
                showToast("Erro ao carregar usuários.", "error");
            });
        }

        // --- EVENT LISTENERS ---
        document.querySelector('.tab').addEventListener('click', (event) => {
            if (event.target.classList.contains('tablinks')) {
                const tabName = event.target.dataset.tab;
                openTab(event, tabName);
            }
        });

        document.getElementById('add-usuario-btn').addEventListener('click', () => openUserModal());
        document.getElementById('modal-cancel-btn').addEventListener('click', closeUserModal);
        window.addEventListener('click', (event) => { if (event.target == userModal) closeUserModal(); });

        document.getElementById('modal-save-btn').addEventListener('click', async () => {
            const id = document.getElementById('user-id').value;
            const funcoesSelecionadas = [];
            document.querySelectorAll('input[name="funcoes"]:checked').forEach(cb => funcoesSelecionadas.push(cb.value));

            const userData = {
                nome: document.getElementById('user-nome').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                contato: document.getElementById('user-tel').value.trim(),
                funcoes: funcoesSelecionadas,
                inativo: document.getElementById('user-inativo').checked,
            };

            if (!userData.nome || !userData.email) {
                showToast('Nome e E-mail são obrigatórios.', 'error');
                return;
            }

            try {
                if (id) {
                    await usuariosCollection.doc(id).update(userData);
                    showToast('Usuário atualizado com sucesso!', 'success');
                } else {
                    const snapshot = await usuariosCollection.where('email', '==', userData.email).get();
                    if (!snapshot.empty) throw new Error('Já existe um usuário com este e-mail.');
                    
                    await usuariosCollection.add(userData);
                    showToast('Usuário adicionado com sucesso!', 'success');
                    alert('IMPORTANTE: O usuário foi criado apenas no banco de dados. Você precisa criar a conta correspondente no Firebase Authentication para que o login funcione.');
                }
                closeUserModal();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
            }
        });

        document.getElementById('usuarios-table').addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            if (!userId) return;

            if (e.target.classList.contains('edit-row-btn')) {
                const userToEdit = localUsuariosList.find(u => u.id === userId);
                if(userToEdit) openUserModal(userToEdit);
            }

            if (e.target.classList.contains('delete-row-btn')) {
                if (confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                    usuariosCollection.doc(userId).delete()
                        .then(() => showToast('Usuário excluído!', 'success'))
                        .catch(err => showToast('Erro ao excluir: ' + err.message, 'error'));
                }
            }
        });

        // --- INICIALIZAÇÃO DA PÁGINA ---
        const defaultOpenButton = document.getElementById("defaultOpen");
        if (defaultOpenButton) {
            defaultOpenButton.click();
        }
        loadUsuarios();
    })();
</script>
