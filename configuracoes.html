<div id="toast-container"></div>
<div class="container">
    <h1>Configurações Gerais</h1>
    <div class="tab">
        <button class="tablinks" data-tab="GestaoUsuarios" id="defaultOpen">Gestão de Usuários</button>
    </div>

    <div id="GestaoUsuarios" class="tabcontent">
        <h2>Gestão de Usuários do Sistema</h2>
        <p>Adicione ou edite os dados de um usuário. O e-mail deve corresponder ao usado para login no Google.</p>
        <div class="button-bar">
            <button class="action-button add-row-btn" id="add-usuario-btn">Adicionar Usuário</button>
        </div>
        <div style="overflow-x: auto;">
            <table id="usuarios-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Username</th> <th>Profissão</th> <th>Faz Atendimento?</th> <th>Funções</th>
                        <th>1ª Fase?</th>
                        <th>Recebe Direto?</th>
                        <th>Inativo?</th>
                        <th style="min-width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2 id="modal-title">Adicionar Novo Usuário</h2></div>
        <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-group"><label for="user-nome">Nome Completo</label><input type="text" id="user-nome" required></div>
                <div class="form-group"><label for="user-email">E-mail (para login)</label><input type="email" id="user-email" required></div>
                <div class="form-group"><label for="user-tel">Telefone</label><input type="text" id="user-tel" required></div>
                
                <div class="form-group">
                    <label for="user-profissao">Profissão</label>
                    <select id="user-profissao">
                        <option value="">Não especificada</option>
                        <option value="Psicologo">Psicólogo(a)</option>
                        <option value="Psicopedagogo">Psicopedagogo(a)</option>
                        <option value="Musicoterapeuta">Musicoterapeuta</option>
                        <option value="Nutricionista">Nutricionista</option>
                        <option value="Assistente Social">Assistente Social</option>
                        <option value="Outra">Outra</option>
                    </select>
                    <input type="text" id="user-profissao-outra" placeholder="Digite a profissão" style="display:none; margin-top: 8px;">
                </div>

                <div class="form-group checkbox-group">
                    <h4>Funções de Acesso:</h4>
                    <label><input type="checkbox" name="funcoes" value="admin"> Admin</label>
                    <label><input type="checkbox" name="funcoes" value="financeiro"> Financeiro</label>
                    <label><input type="checkbox" name="funcoes" value="gestor"> Gestor</label>
                    <label><input type="checkbox" name="funcoes" value="supervisor"> Supervisor</label>
                </div>
                <div class="form-group checkbox-group">
                    <h4>Status e Condições:</h4>
                     <label><input type="checkbox" id="user-faz-atendimento"> Faz Atendimento?</label> <label><input type="checkbox" id="user-primeira-fase"> Primeira Fase?</label>
                     <label><input type="checkbox" id="user-recebe-direto"> Recebe Direto?</label>
                     <label><input type="checkbox" id="user-inativo"> Marcar como Inativo?</label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="modal-cancel-btn" class="action-button" style="background-color: #6c757d;">Cancelar</button>
            <button id="modal-save-btn" class="action-button" style="background-color: #28a745;">Salvar</button>
        </div>
    </div>
</div>

<style>
    /* ... seu CSS completo ... */
</style>

<script>
    (function() {
        const usuariosCollection = db.collection('usuarios');
        const userModal = document.getElementById('user-modal');
        let localUsuariosList = []; 

        function openTab(evt, tabName) { /* ...código inalterado... */ }
        function showToast(message, type = 'success') { /* ...código inalterado... */ }

        function openUserModal(user = null) {
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('modal-title').textContent = user ? 'Editar Usuário' : 'Adicionar Novo Usuário';
            document.getElementById('user-id').value = user ? user.id : '';
            document.getElementById('user-email').disabled = !!user;
            
            // Esconde o campo "outra profissão" por padrão
            document.getElementById('user-profissao-outra').style.display = 'none';

            if (user) {
                document.getElementById('user-nome').value = user.nome || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-tel').value = user.contato || '';
                document.getElementById('user-inativo').checked = user.inativo || false;
                document.getElementById('user-primeira-fase').checked = user.primeiraFase || false;
                document.getElementById('user-recebe-direto').checked = user.recebeDireto || false;
                document.getElementById('user-faz-atendimento').checked = user.fazAtendimento || false; // ADICIONADO

                // Lógica para preencher a profissão
                const profissaoSelect = document.getElementById('user-profissao');
                const profissaoOutraInput = document.getElementById('user-profissao-outra');
                const options = Array.from(profissaoSelect.options).map(opt => opt.value);
                if (user.profissao && options.includes(user.profissao)) {
                    profissaoSelect.value = user.profissao;
                } else if (user.profissao) {
                    profissaoSelect.value = 'Outra';
                    profissaoOutraInput.value = user.profissao;
                    profissaoOutraInput.style.display = 'block';
                }
                
                form.querySelectorAll('input[name="funcoes"]').forEach(checkbox => {
                    checkbox.checked = user.funcoes && user.funcoes.includes(checkbox.value);
                });
            }
            userModal.style.display = 'block';
        }

        function closeUserModal() { userModal.style.display = 'none'; }

        function renderTable(usuariosList) {
            const tableBody = document.querySelector('#usuarios-table tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            
            usuariosList.forEach(user => {
                const row = tableBody.insertRow();
                const funcoesStr = Array.isArray(user.funcoes) ? user.funcoes.join(', ') : 'Nenhuma';
                // ADICIONADAS as novas colunas
                row.innerHTML = `
                    <td>${user.nome || ''}</td>
                    <td>${user.username || ''}</td>
                    <td>${user.profissao || 'N/A'}</td>
                    <td style="text-align: center;">${user.fazAtendimento ? 'Sim' : 'Não'}</td>
                    <td>${funcoesStr}</td>
                    <td style="text-align: center;">${user.primeiraFase ? 'Sim' : 'Não'}</td>
                    <td style="text-align: center;">${user.recebeDireto ? 'Sim' : 'Não'}</td>
                    <td style="text-align: center;">${user.inativo ? 'Sim' : 'Não'}</td>
                    <td>
                        <button class="action-button edit-row-btn" data-id="${user.id}">Editar</button>
                        <button class="action-button delete-row-btn" data-id="${user.id}">Excluir</button>
                    </td>`;
            });
        }

        function loadUsuarios() {
            usuariosCollection.orderBy('nome').onSnapshot(snapshot => {
                localUsuariosList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable(localUsuariosList);
            }, error => {
                console.error("Erro ao carregar usuários: ", error);
                showToast("Erro ao carregar usuários.", "error");
            });
        }

        // --- EVENT LISTENERS ---
        document.querySelector('.tab').addEventListener('click', (event) => { /* ...código inalterado... */ });
        document.getElementById('add-usuario-btn').addEventListener('click', () => openUserModal());
        document.getElementById('modal-cancel-btn').addEventListener('click', closeUserModal);
        
        // Listener para o dropdown de profissão
        document.getElementById('user-profissao').addEventListener('change', (e) => {
            const outraInput = document.getElementById('user-profissao-outra');
            outraInput.style.display = e.target.value === 'Outra' ? 'block' : 'none';
        });

        document.getElementById('modal-save-btn').addEventListener('click', async () => {
            const id = document.getElementById('user-id').value;
            const funcoesSelecionadas = [];
            document.querySelectorAll('input[name="funcoes"]:checked').forEach(cb => funcoesSelecionadas.push(cb.value));

            // Lógica para pegar o valor da profissão (seja do select ou do campo de texto)
            let profissaoFinal = document.getElementById('user-profissao').value;
            if (profissaoFinal === 'Outra') {
                profissaoFinal = document.getElementById('user-profissao-outra').value.trim();
            }

            const userData = {
                nome: document.getElementById('user-nome').value.trim(),
                email: document.getElementById('user-email').value.trim(),
                contato: document.getElementById('user-tel').value.trim(),
                funcoes: funcoesSelecionadas,
                inativo: document.getElementById('user-inativo').checked,
                primeiraFase: document.getElementById('user-primeira-fase').checked,
                recebeDireto: document.getElementById('user-recebe-direto').checked,
                profissao: profissaoFinal, // ADICIONADO
                fazAtendimento: document.getElementById('user-faz-atendimento').checked, // ADICIONADO
            };

            if (!userData.nome || !userData.email) { /* ...código de validação inalterado... */ }

            const saveBtn = document.getElementById('modal-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            try {
                if (id) { 
                    // Para editar, precisamos gerar o username aqui, pois a Cloud Function não é chamada
                    const gerarUsername = (nomeCompleto) => {
                      if (!nomeCompleto) return "";
                      const nomes = nomeCompleto.trim().split(" ").filter(Boolean);
                      if (nomes.length <= 1) return nomes[0] || "";
                      return `${nomes[0]} ${nomes[nomes.length - 1]}`;
                    };
                    userData.username = gerarUsername(userData.nome);

                    await usuariosCollection.doc(id).update(userData);
                    showToast('Usuário atualizado com sucesso!', 'success');
                } else { 
                    const criarUsuario = firebase.functions().httpsCallable('criarUsuarioComDados');
                    const result = await criarUsuario(userData);
                    showToast(result.data.message, 'success');
                }
                closeUserModal();
            } catch (error) {
                showToast('Erro: ' + error.message, 'error');
                console.error("Erro ao salvar usuário:", error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Salvar';
            }
        });

        document.getElementById('usuarios-table').addEventListener('click', (e) => { /* ...código inalterado... */ });

        // --- INICIALIZAÇÃO DA PÁGINA ---
        const defaultOpenButton = document.getElementById("defaultOpen");
        if (defaultOpenButton) {
            defaultOpenButton.click();
        }
        loadUsuarios();
    })();
</script>