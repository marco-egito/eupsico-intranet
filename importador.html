<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Importador e Criador de Usuários em Lote</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        button { padding: 12px 25px; font-size: 1.1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; margin-right: 10px; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #log { border: 1px solid #ccc; background-color: #333; color: #fff; margin-top: 20px; padding: 10px; height: 300px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; font-weight: bold; }
        .log-info { color: #17a2b8; }
        #auth-status { background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
    </style>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Importar e Criar Novos Usuários em Lote</h1>
        
        <div id="auth-status">
            <p id="auth-message">Aguardando login...</p>
            <button id="login-btn">Fazer Login com Google</button>
        </div>

        <div id="importer-content" style="display: none;">
            <p>Esta ferramenta chama a Cloud Function para criar cada usuário na Autenticação e no Firestore.</p>
            <div class="form-group">
                <label for="file-input">1. Selecione o Arquivo Excel (.xlsx) com os novos usuários:</label>
                <input type="file" id="file-input" accept=".xlsx, .xls">
            </div>
            <button id="import-btn">2. Iniciar Criação em Lote</button>
        </div>

        <h3>Log da Importação:</h3>
        <div id="log"></div>
    </div>

    <script type="module">
        // Importe apenas as funções que você precisa
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, getIdToken } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLeWW39nqxsdv1YD-CNa9RSTv05lGHJxM",
            authDomain: "eupsico-agendamentos-d2048.firebaseapp.com",
            databaseURL: "https://eupsico-agendamentos-d2048-default-rtdb.firebaseio.com",
            projectId: "eupsico-agendamentos-d2048",
            storageBucket: "eupsico-agendamentos-d2048.appspot.com",
            messagingSenderId: "1041518416343",
            appId: "1:1041518416343:web:3b972c212c52a59ad7bb92"
        };
        
        // Inicialize o Firebase e os serviços
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'us-central1'); // Especifique a região da sua função

        const loginBtn = document.getElementById('login-btn');
        const importBtn = document.getElementById('import-btn');
        const fileInput = document.getElementById('file-input');
        const logDiv = document.getElementById('log');
        const authMessage = document.getElementById('auth-message');
        const importerContent = document.getElementById('importer-content');

        function log(message, type = 'info') {
            logDiv.innerHTML += `<p class="log-${type}">[${new Date().toLocaleTimeString()}] ${message}</p>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Nova sintaxe para observar o estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authMessage.textContent = `Logado como: ${user.email}`;
                loginBtn.style.display = 'none';
                importerContent.style.display = 'block';
                log('Usuário autenticado. Pronto para importar.', 'success');
            } else {
                authMessage.textContent = 'Você precisa estar logado para usar esta ferramenta.';
                loginBtn.style.display = 'block';
                importerContent.style.display = 'none';
            }
        });

        loginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => log(err.message, 'error'));
        });

        importBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                log('Por favor, selecione um arquivo Excel.', 'error'); return;
            }

            importBtn.disabled = true;
            importBtn.textContent = 'Processando...';
            log(`Iniciando importação do arquivo: "${file.name}"`);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) throw new Error('A planilha parece estar vazia.');
                    
                    log(`Planilha lida com sucesso. ${jsonData.length} usuários encontrados.`);
                    log('Iniciando chamadas para a Cloud Function. Isso pode demorar...');
                    
                    if (!auth.currentUser) throw new Error("Usuário não está logado ou a sessão expirou.");
                    
                    log('Atualizando token de autenticação antes de iniciar o lote...', 'info');
                    // Nova sintaxe para renovar o token
                    await getIdToken(auth.currentUser, true); 
                    log('Token atualizado. Iniciando processo em lote...', 'success');

                    // Nova sintaxe para obter a referência da função
                    const criarUsuario = httpsCallable(functions, 'criarUsuarioComDados');
                    let successCount = 0;
                    let errorCount = 0;

                    for (const row of jsonData) {
                        const sanitizedUserData = {
                            nome: row.nome || '',
                            email: row.email || '',
                            contato: row.contato || '',
                            profissao: row.profissao || 'Não especificada',
                            funcoes: (typeof row.funcoes === 'string') ? row.funcoes.split(',').map(f => f.trim()).filter(Boolean) : [],
                            fazAtendimento: String(row.fazAtendimento).toUpperCase() === 'TRUE',
                            primeiraFase: String(row.primeiraFase).toUpperCase() === 'TRUE',
                            recebeDireto: String(row.recebeDireto).toUpperCase() === 'TRUE',
                            inativo: String(row.inativo).toUpperCase() === 'TRUE'
                        };
                        
                        if (!sanitizedUserData.email) {
                            log(` -> FALHA: Linha ignorada por não conter um e-mail.`, 'error');
                            errorCount++;
                            continue;
                        }

                        log(`Processando: ${sanitizedUserData.email}...`);
                        
                        try {
                            await criarUsuario(sanitizedUserData);
                            log(` -> SUCESSO: Usuário ${sanitizedUserData.email} criado.`, 'success');
                            successCount++;
                        } catch (error) {
                            log(` -> FALHA ao criar ${sanitizedUserData.email}: ${error.message}`, 'error');
                            errorCount++;
                        }
                    }

                    log('------------------------------------', 'info');
                    log(`Processo concluído!`, 'info');
                    log(`- ${successCount} usuários criados com sucesso.`, 'success');
                    log(`- ${errorCount} falharam ou foram ignorados.`, 'error');

                } catch (error) {
                    log(`ERRO GERAL: ${error.message}`, 'error');
                    console.error(error);
                } finally {
                    importBtn.disabled = false;
                    importBtn.textContent = '2. Iniciar Criação em Lote';
                    fileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>
