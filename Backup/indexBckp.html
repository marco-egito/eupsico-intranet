<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Intranet EuPsico</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 20px; text-align: center; }
        .app-container { max-width: 800px; margin: auto; }
        .view { display: none; } /* Esconde todas as se√ß√µes por padr√£o */
        .visible { display: block; } /* Mostra a se√ß√£o ativa */
        .content-box { background-color: white; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd; }
        #login-button { background-color: #004a7f; color: white; border: none; font-size: 1.1em; }
        #logout-button { background-color: #6c757d; color: white; border: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        .user-info { display: flex; align-items: center; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .user-info span { font-weight: bold; }
        #nav-links button { display: block; width: 100%; margin: 10px 0; text-align: left; background-color: #f1f1f1; border: 1px solid #ddd; padding: 15px; }
        #nav-links button:hover { background-color: #e0e0e0; }
        .back-button { display: inline-block; margin-bottom: 20px; font-weight: bold; cursor: pointer; color: #004a7f; background: none; border: none; padding: 0; text-align: left; }
    </style>
</head>
<body>
    <div class="app-container">

        <div id="login-view" class="view content-box">
            <img src="https://i.ibb.co/JwdDSZx/Cabe-a-ho.png" alt="Logo EuPsico" style="max-width: 300px; margin-bottom: 20px;">
            <h2>Intranet EuPsico</h2>
            <p>Por favor, fa√ßa login para continuar.</p>
            <button id="login-button">Login com Google</button>
        </div>

        <div id="loading-view" class="view">
            <p>Verificando autentica√ß√£o...</p>
        </div>
        
        <div id="dashboard-view" class="view content-box">
            <div class="header">
                <div class="user-info">
                    <img id="user-photo" src="" alt="Foto">
                    <span id="user-name"></span>
                </div>
                <button id="logout-button">Sair</button>
            </div>
            <h2>Painel de Acesso</h2>
            <p>Selecione a √°rea que deseja acessar:</p>
            <div id="nav-links">
                </div>
        </div>

        <div id="financeiro-view" class="view content-box">
            <button class="back-button" onclick="showView('dashboard-view')">‚Üê Voltar ao Painel</button>
            <h2 style="text-align: left;">√Årea Financeira</h2>
            <p style="text-align: left;">Aqui fica todo o conte√∫do exclusivo da √°rea financeira.</p>
            </div>

        <div id="rh-view" class="view content-box">
            <button class="back-button" onclick="showView('dashboard-view')">‚Üê Voltar ao Painel</button>
            <h2 style="text-align: left;">Recursos Humanos</h2>
            <p style="text-align: left;">Aqui fica todo o conte√∫do exclusivo da √°rea de RH.</p>
            </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // !! IMPORTANTE: Use o MESMO firebaseConfig em todos os lugares !!
            const firebaseConfig = {
              apiKey: "AIzaSyCLeWW39nqxsdv1YD-CNa9RSTv05lGHJxM",
              authDomain: "eupsico-agendamentos-d2048.firebaseapp.com",
              databaseURL: "https://eupsico-agendamentos-d2048-default-rtdb.firebaseio.com",
              projectId: "eupsico-agendamentos-d2048",
              storageBucket: "eupsico-agendamentos-d2048.firebasestorage.app",
              messagingSenderId: "1041518416343",
              appId: "1:1041518416343:web:3a0abc73404ccd51d7bb92"
            };
                        firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const loginView = document.getElementById('login-view');
            const loadingView = document.getElementById('loading-view');
            const dashboardView = document.getElementById('dashboard-view');
            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const navLinks = document.getElementById('nav-links');

            // Fun√ß√£o para mostrar a view correta
            function showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('visible'));
                document.getElementById(viewId).classList.add('visible');
            }

            // Monitora o estado da autentica√ß√£o
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Usu√°rio est√° logado, busca as permiss√µes
                    const userDoc = await db.collection('usuarios').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().funcoes && userDoc.data().funcoes.length > 0) {
                        const funcoes = userDoc.data().funcoes;
                        renderDashboard(user, funcoes); // Monta o dashboard com os links corretos
                        showView('dashboard-view'); // Mostra o dashboard
                    } else {
                        // Usu√°rio autenticado, mas sem permiss√£o no Firestore
                        document.body.innerHTML = `<div class="content-box"><h2>Acesso Negado</h2><p>Voc√™ est√° autenticado, mas seu usu√°rio n√£o tem permiss√µes definidas. Contate o administrador.</p><button onclick="firebase.auth().signOut()">Sair</button></div>`;
                    }
                } else {
                    // Usu√°rio n√£o est√° logado
                    console.log("Nenhum usu√°rio logado.");
                    showView('login-view'); // Mostra a tela de login
                }
            });

            // Fun√ß√£o para montar o dashboard dinamicamente
            function renderDashboard(user, funcoes) {
                userPhoto.src = user.photoURL;
                userName.textContent = user.displayName;
                navLinks.innerHTML = ''; // Limpa os links antigos

                // Define quais bot√µes levam para quais "telas" (views)
                const linksPorFuncao = {
                    'financeiro': { titulo: 'üí∞ Acesso Financeiro', view: 'financeiro-view' },
                    'rh': { titulo: 'üë• Recursos Humanos', view: 'rh-view' }
                    // Adicione outras fun√ß√µes e views aqui
                };

                const botoesParaMostrar = new Set();

                // Se o usu√°rio for admin, ele v√™ todos os links.
                if (funcoes.includes('admin')) {
                    Object.values(linksPorFuncao).forEach(link => botoesParaMostrar.add(link));
                } else {
                    // Outros usu√°rios veem apenas os bot√µes de suas fun√ß√µes
                    funcoes.forEach(funcao => {
                        if (linksPorFuncao[funcao]) {
                            botoesParaMostrar.add(linksPorFuncao[funcao]);
                        }
                    });
                }

                // Cria e adiciona os bot√µes na tela
                botoesParaMostrar.forEach(config => {
                    const btn = document.createElement('button');
                    btn.textContent = config.titulo;
                    btn.onclick = () => showView(config.view); // Ao clicar, mostra a "tela" correspondente
                    navLinks.appendChild(btn);
                });
            }

            // A√ß√£o do bot√£o de login
            loginButton.addEventListener('click', () => {
                showView('loading-view'); // Mostra "carregando" ao iniciar o login
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Erro durante o login com popup:", error);
                    alert("Ocorreu um erro ao tentar fazer login: " + error.message);
                    showView('login-view'); // Volta para a tela de login em caso de erro
                });
            });

            // A√ß√£o do bot√£o de logout
            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            // Inicia mostrando a tela de carregamento para evitar piscar a tela de login
            showView('loading-view');
        });
    </script>
</body>
</html>
