<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Intranet EuPsico</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 20px; text-align: center; }
        .app-container { max-width: 800px; margin: auto; }
        .view { display: none; }
        .visible { display: block; }
        .content-box { background-color: white; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 20px; text-align: left; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: 1px solid #ddd; }
        #login-button { background-color: #004a7f; color: white; border: none; font-size: 1.1em; }
        #logout-button { background-color: #6c757d; color: white; border: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        .user-info { display: flex; align-items: center; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .user-info span { font-weight: bold; }
        #nav-links a, #nav-links button { display: block; width: 100%; margin: 10px 0; text-align: left; background-color: #f1f1f1; border: 1px solid #ddd; padding: 15px; text-decoration: none; color: #333; font-size: 1em; }
        #nav-links a:hover, #nav-links button:hover { background-color: #e0e0e0; }
    </style>
</head>
<body>
    <div class="app-container">

        <div id="login-view" class="view" style="text-align: center;">
             <div class="content-box">
                <img src="https://i.ibb.co/JwdDSZx/Cabe-a-ho.png" alt="Logo EuPsico" style="max-width: 300px; margin-bottom: 20px;">
                <h2>Intranet EuPsico</h2>
                <p>Por favor, fa√ßa login para continuar.</p>
                <button id="login-button">Login com Google</button>
            </div>
        </div>

        <div id="loading-view" class="view">
            <p>Verificando autentica√ß√£o...</p>
        </div>
        
        <div id="dashboard-view" class="view content-box">
            <div class="header">
                <div class="user-info">
                    <img id="user-photo" src="" alt="Foto">
                    <span id="user-name"></span>
                </div>
                <button id="logout-button">Sair</button>
            </div>
            <h2>Painel de Acesso</h2>
            <p>Selecione a √°rea que deseja acessar:</p>
            <div id="nav-links">
                </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const firebaseConfig = {
              apiKey: "AIzaSyCLeWW39nqxsdv1YD-CNa9RSTv05lGHJxM",
              authDomain: "eupsico-agendamentos-d2048.firebaseapp.com",
              databaseURL: "https://eupsico-agendamentos-d2048-default-rtdb.firebaseio.com",
              projectId: "eupsico-agendamentos-d2048",
              storageBucket: "eupsico-agendamentos-d2048.appspot.com",
              messagingSenderId: "1041518416343",
              appId: "1:1041518416343:web:3b972c212c52a59ad7bb92"
            };
            
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            const loginButton = document.getElementById('login-button');
            const logoutButton = document.getElementById('logout-button');
            const userPhoto = document.getElementById('user-photo');
            const userName = document.getElementById('user-name');
            const navLinks = document.getElementById('nav-links');

            function showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('visible'));
                document.getElementById(viewId).classList.add('visible');
            }

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('usuarios').doc(user.uid).get();
                    if (userDoc.exists && userDoc.data().funcoes && userDoc.data().funcoes.length > 0) {
                        const funcoes = userDoc.data().funcoes;
                        renderDashboard(user, funcoes);
                        showView('dashboard-view');
                    } else {
                        document.body.innerHTML = `<div class="content-box" style="max-width: 800px; margin: auto; text-align: center;"><h2>Acesso Negado</h2><p>Voc√™ est√° autenticado, mas seu usu√°rio n√£o tem permiss√µes definidas. Contate o administrador.</p><button onclick="firebase.auth().signOut()">Sair</button></div>`;
                    }
                } else {
                    showView('login-view');
                }
            });

            function renderDashboard(user, funcoes) {
                userPhoto.src = user.photoURL || '';
                userName.textContent = user.displayName || 'Usu√°rio';
                navLinks.innerHTML = '';

                // Mapeamento de todas as √°reas dispon√≠veis
                const areas = {
                    intranet: { titulo: 'üåê Intranet Geral', url: 'URL_DA_INTRANET_GERAL_AQUI', roles: ['admin', 'todos'] }, // 'todos' √© uma role imagin√°ria para acesso geral
                    administrativo: { titulo: 'üìÅ Administrativo', url: '#', roles: ['admin', 'administrativo'] },
                    captacao: { titulo: 'üéØ Capta√ß√£o', url: '#', roles: ['admin', 'captacao'] },
                    financeiro: { titulo: 'üí∞ Financeiro', url: './painel.html', roles: ['admin', 'financeiro'] },
                    grupos: { titulo: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Grupos', url: '#', roles: ['admin', 'grupos'] },
                    marketing: { titulo: 'üìà Marketing', url: '#', roles: ['admin', 'marketing'] },
                    plantao: { titulo: 'üìû Plant√£o', url: '#', roles: ['admin', 'plantao'] },
                    rh: { titulo: 'üë• Recursos Humanos', url: '#', roles: ['admin', 'rh'] },
                    servico_social: { titulo: 'ü§ù Servi√ßo Social', url: '#', roles: ['admin', 'servico_social'] },
                    supervisao: { titulo: 'üë®‚Äçüè´ Supervis√£o', url: '#', roles: ['admin', 'supervisao'] },
                };

                let botoesParaMostrar = [];

                // Adiciona os bot√µes que o usu√°rio tem permiss√£o para ver
                for (const key in areas) {
                    const area = areas[key];
                    // O usu√°rio v√™ o link se for admin ou se tiver alguma das roles necess√°rias para aquela √°rea
                    const temPermissao = funcoes.includes('admin') || area.roles.some(role => funcoes.includes(role));
                    
                    if (temPermissao) {
                        botoesParaMostrar.push(area);
                    }
                }

                // Ordena os bot√µes em ordem alfab√©tica pelo t√≠tulo, exceto a Intranet Geral que fica primeiro
                botoesParaMostrar.sort((a, b) => {
                    if (a.titulo.includes('Intranet Geral')) return -1;
                    if (b.titulo.includes('Intranet Geral')) return 1;
                    return a.titulo.localeCompare(b.titulo);
                });
                
                // Cria os elementos <a> e os adiciona na tela
                botoesParaMostrar.forEach(config => {
                    const link = document.createElement('a');
                    link.textContent = config.titulo;
                    link.href = config.url;
                    // Abre em nova aba se n√£o for um link interno simples
                    if (config.url.startsWith('http') || config.url.endsWith('.html')) {
                        link.target = '_blank';
                    }
                    navLinks.appendChild(link);
                });
            }

            loginButton.addEventListener('click', () => {
                showView('loading-view');
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Erro durante o login com popup:", error);
                    showView('login-view');
                });
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            showView('loading-view');
        });
    </script>
</body>
</html>
